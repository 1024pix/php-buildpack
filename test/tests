#!/usr/bin/env bash

source "$( pwd )/test/utils"
source "$( pwd )/test/helpers"

readonly default_modules=(
    "apcu" "bcmath" "bz2" "Core" "ctype" "curl" "date" "dom" "exif" "fileinfo"
    "filter" "gd" "hash" "iconv" "intl" "json" "libxml" "mbstring" "mongodb"
    "mysqli" "mysqlnd" "openssl" "pcntl" "pcre" "PDO" "pdo_mysql" "pdo_pgsql"
    "pdo_sqlite" "pgsql" "Phar" "posix" "readline" "redis" "Reflection"
    "session" "shmop" "SimpleXML" "soap" "sockets" "SPL" "sqlite3" "standard"
    "tokenizer" "xml" "xmlreader" "xmlwriter" "xsl" "Zend OPcache" "zip" "zlib"
)

test::detect_legacy_default() {
    # Test the buildpack detect script with a single simple .php file
    test::utils::detect "legacy_default"
    test::utils::assertCapturedSuccess
    test::utils::assertCapturedEquals "PHP (classic)"
}

test::detect_composer_default() {
    test::utils::detect "composer_default"
    test::utils::assertCapturedSuccess
    test::utils::assertCapturedEquals "PHP (composer.json)"
}

test::compile_legacy_default() {
    test::helpers::test_compile "legacy_default" "8.1."
}

test::compile_composer_default() {
    test::helpers::test_compile "composer_default" "8.1."
}

test::compile_composer_php80() {
    test::helpers::test_compile "composer_php80" "8.0."
}

test::compile_composer_php81() {
    test::helpers::test_compile "composer_php81" "8.1."
}

test::compile_composer_php82() {
    test::helpers::test_compile "composer_php82" "8.2."
}

test::compile_composer_php83() {
    test::helpers::test_compile "composer_php83" "8.3."
}

# Add these functions to the test suite:

suite_addTest test::detect_legacy_default
suite_addTest test::compile_legacy_default
suite_addTest test::detect_composer_default
suite_addTest test::compile_composer_default
suite_addTest test::compile_composer_php80
suite_addTest test::compile_composer_php81
suite_addTest test::compile_composer_php82
suite_addTest test::compile_composer_php83
