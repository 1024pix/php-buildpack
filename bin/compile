#!/bin/bash

set -e
shopt -s dotglob

if [ -n "$BUILDPACK_DEBUG" ]; then
    set -x
fi

if [ -z "$S3_BUCKET" ]; then
    S3_BUCKET="chh-heroku-buildpack-php"
fi

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

function fetch_package() {
    local engine="$1"
    local version="$2"
    local location="$3"

    mkdir -p "$location"

    local package="http://${S3_BUCKET}.s3.amazonaws.com/package/${engine}-${version}.tgz"

    curl "$package" -L -s -o - | tar xzf - -C "$location"
}

function indent() {
    c='s/^/       /'
    case $(uname) in
        Darwin) sed -l "$c";;
        *)      sed -u "$c";;
    esac
}

function install_composer_deps() {
    local cwd=$(pwd)
    local target="$1"

    mkdir -p "$CACHE_DIR/composer/${PHP_VERSION}"

    if [ -d "$CACHE_DIR/composer/${PHP_VERSION}/vendor" ]; then
        cp -R "$CACHE_DIR/composer/${PHP_VERSION}/vendor/" "$target/vendor"
    fi

    echo "-----> Vendoring Composer"
    {
        mkdir -p "$target/vendor/composer/bin"
        curl -L "http://getcomposer.org/composer.phar" > "$target/vendor/composer/bin/composer.phar"
        chmod a+x "$target/vendor/composer/bin/composer.phar"
    } | indent

    echo "-----> Installing application dependencies with Composer"
    {
        cd "$target"
        "$BUILD_DIR/vendor/php/bin/php" \
            "$target/vendor/composer/bin/composer.phar" install \
            --prefer-dist \
            --optimize-autoloader \
            --no-interaction

        cp -R "$target/vendor/" "$CACHE_DIR/composer/${PHP_VERSION}/vendor"
        cd "$cwd"
    } | indent
}

function mktmpdir() {
    dir=$(mktemp -t php-$1-XXXX)
    rm -rf $dir
    mkdir -p $dir
    echo $dir
}

function render_erb() {
    local file="$1"
    shift

    vars=
    for arg in $@; do
        local k=$(echo "$arg" | cut -f1 -d=)
        local v=$(echo "$arg" | cut -f2 -d=)

        vars="${vars}$k='$v';"
    done

    script="%s puts ERB.new(File.read('%s')).result(binding);"

    ruby -rerb -e "$(printf "$script" "$vars" "$file")"
}

function package_document_root() {
    echo "/app"
}

function package_index_file() {
    echo "index.php"
}

function package_framework() {
    eval local framework=$(cat "$BUILD_DIR/composer.json" | jq '.extra.heroku.framework')
    echo "$framework"
}

BUILD_DIR="$1"
CACHE_DIR="$2"

cd "$BUILD_DIR"

#declare -A engine_versions
#declare -A engine_defaults
#declare -A engine_requests

#engine_defaults["php"] = "5.4.13"
#engine_defaults["nginx"] = "1.2.7"

PHP_VERSION=5.4.14
NGINX_VERSION=1.2.7

# Download jq binary for JSON processing
export PATH="$HOME/bin:$PATH"
curl "http://stedolan.github.com/jq/download/linux64/jq" -L -s -o - > "$HOME/bin/jq"
chmod +x "$HOME/bin/jq"

echo "-----> Vendoring NGINX ${NGINX_VERSION} | PHP ${PHP_VERSION}"

VENDORED_NGINX=$(mktmpdir nginx)
VENDORED_PHP=$(mktmpdir php)

fetch_package nginx "$NGINX_VERSION" "$VENDORED_NGINX"
fetch_package php "$PHP_VERSION" "$VENDORED_PHP"

echo "-----> Vendoring binaries into slug"

[ ! -d "$BUILD_DIR/vendor" ] && mkdir -p "$BUILD_DIR/vendor"

cp -R "$VENDORED_NGINX/" "vendor/nginx" | indent
cp -R "$VENDORED_PHP/" "vendor/php" | indent

# Test that all packages were fetched and"extracted successfully
test -d "vendor/nginx"
test -d "vendor/php"

mkdir -p "conf"
cp "$basedir/../conf/nginx/default.conf.erb" "conf/nginx.conf.erb"
cp "$basedir/../conf/php/php-fpm.conf" "vendor/php/etc/php-fpm.conf"

FRAMEWORK=$(package_framework)

if [ -f "$basedir/conf/nginx/$FRAMEWORK.conf.erb" ]; then
    echo "-----> Configuring $FRAMEWORK app"
    cp "$basedir/conf/nginx/$FRAMEWORK.conf.erb" "conf/$FRAMEWORK.conf.erb"

    echo "include $FRAMEWORK.conf.erb;" >> conf/nginx.conf.erb
fi

test ! -d ".profile.d" && mkdir -p .profile.d || true

cat > ".profile.d/php.sh" <<SH
export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/app/bin:/app/vendor/nginx/sbin:/app/vendor/php/sbin:/app/vendor/php/bin:\$PATH
SH

install_composer_deps "$BUILD_DIR"

mkdir -p "bin"

cat > "bin/run" <<SH
#!/usr/bin/env bash

for var in \`env | cut -f1 -d=\`; do
    echo "env[\$var] = \\$\${var}" >> /app/vendor/php/etc/php-fpm.conf
done

export DOCUMENT_ROOT="$(package_document_root)"
export INDEX_DOCUMENT="$(package_index_file)"

erb conf/nginx.conf.erb > /app/vendor/nginx/conf/nginx.conf
erb conf/$(package_framework).conf.erb > /app/vendor/nginx/conf/$(package_framework).conf

mkdir -p /app/vendor/nginx/logs
mkdir -p /app/vendor/php/var/log
mkdir -p /app/vendor/php/run

touch /app/vendor/nginx/logs/access.log /app/vendor/nginx/logs/error.log
touch /app/vendor/php/var/log/error.log

(tail -f -n 0 /app/vendor/nginx/logs/*.log /app/vendor/php/var/log/*.log &)

php-fpm -p "/app/vendor/php"
nginx -p "/app/vendor/nginx" -c /app/vendor/nginx/conf/nginx.conf
SH

chmod a+x "bin/run"
